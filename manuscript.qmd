---
title: "Probabilistic Model of Bilateral Lymphatic Spread in Head and Neck Cancer"
abstract: |
  Purpose: According to current guidelines for elective nodal irradiation of oropharyngeal squamous cell carcinoma (OPSCC) patients, large parts of the contralateral lymphatic system are included in the elective clinical target volume (CTV-N), even for lateralized tumors without clinical lymph node involvement in the contralateral neck. In this work, we present a probabilistic model for bilateral lymphatic tumor progression in OPSCC to predict the personal risk for occult disease in any lymph node level (LNL), given the patient's clinical lymph node involvement, T-stage, and lateralization of the primary tumor.

  Methods: We extend a hidden markov model for lymphatic tumor progression, which was previously developed for ipsilateral lymph node involvement, to the contralateral neck. The model represents each of the LNLs I, II, III, IV, V, and VII of both sides of the neck as a hidden binary random variable with states healthy and involved. LNLs are connected to the tumor and among each other via arcs that correspond to spread probabilities. These spread probability rates are learned via Markov chain Monte Carlo (MCMC) sampling from a dataset of 833 OPSCC patients.

  Results: The model is able to describe the data on lymph node involvement well with a small number of interpretable parameters. Midline extension of the primary tumor is the main risk factor for contralateral involvement. In addition, the risk of occult metastases in contralateral lymph node level increases with more advanced T-stage and more severe ipsilateral involvement. The probability of involvement in contralateral level III is very low if the upstream level II is clinically negative. Similarly, the probability of involvement in contralateral level IV is very low if the upstream level III is clinically negative.

  Conclusions: The model may guide personalized volume reduction of the elective CTV-N. It suggests that the contralateral neck may be spared from elective irradiation for lateralized tumors not crossing the midline. In patients with primary tumors crossing the midline but clinically negative contralateral neck, the contralateral elective irradiation may be limited to level II.
---

```{python}
#| echo: false
import re

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import ticker
from matplotlib.colors import LinearSegmentedColormap
import upsetplot

from lymph import models
from lyscripts import utils
from lyscripts.plot.utils import COLORS

from scripts import shared, paths
from scripts.shared import COL, get_lnl_cols

simple_model = shared.get_model("simple", load_samples=True)
```

```{python}
#| tags: [parameters]
#| echo: false

# width of figures. May depend on number of text columns
full = 17 # cm
half = full
# half =  8 # cm
```

# Introduction

When treating head and neck squamous cell carcinomas (HNSCC) with radiotherapy or surgery, not only the primary tumor and the clinically detected lymph node metastases are targeted. Per current guidelines, large volumes of the neck are part of the elective clinical target volume (CTV-N) [@gregoire_ct-based_2003;@gregoire_delineation_2014;@gregoire_delineation_2018;@eisbruch_intensity-modulated_2002;@biau_selection_2019;@chao_determination_2002;@vorwerk_guidelines_2011;@ferlito_elective_2009]. This is to minimize the risk of regional recurrences due to untreated microscopic disease which cannot be detected by current in-vivo imaging modalities such as computed tomography (CT), magnetic resonance imaging (MRI), or positron emission tomography (PET). However, minimizing the risk of missing occult disease in the lymph drainage region must be balanced against the toxicity related to unnecessary treatment of healthy tissue.

The aforementioned guidelines for the definition of the CTV-N are based on anatomically defined lymph node levels (LNL) [@gregoire_delineation_2014] and the overall prevalence of lymph node metastases in the LNLs. Based on this, they recommend extensive irradiation of both sides of the neck for a majority of patients. However, the overall prevalence of involvement in a given LNL does not equal a patient's personal risk for occult disease in that LNL, which depends on an individual patient's state of tumor progression. Currently, a patient presenting with no clinically detectable nodal disease (cN0) and a small, clearly lateralized T1 tumor, the same recommended contralateral CTV-N as a patient with substantial nodal involvement in the ipsilateral side and an advanced primary tumor that crosses the mid-sagittal plane. Both patients receive extensive elective irradiation of the contralateral LNLs II, III, and IVa [@biau_selection_2019].

To better quantify this personalized risk of occult disease we have previously developed an intuitive, probabilistic hidden Markov model [@ludwig_hidden_2021;@ludwig_modelling_2023] which was originally based on a conceptually similar Bayesian network model [@pouymayou_bayesian_2019]. So far, these models were limited to the ipsilateral side of the neck. The main contribution of this work is the extension of the formalism to include risk predictions for the contralateral side as well. The model may then guide the reduction of the electively irradiated volumes in the contralateral neck for patients whose individual risk for occult disease is low. In turn, this may substantially reduce the toxicity from irradiation and the associated decrease in quality of life.

The main contributions of this paper are as follows:

1. In section @sec-data we present a multi-centric dataset on lymph node involvement in {{< var data.num_patients >}} OPSCC patients. Based on the dataset the main risk factors for contralateral lymph node involvement are identified and the requirements for the bilateral model extension are described (@sec-requirements).

2. In @sec-ext-to-contra we present a bilateral HMM of lymphatic progression that accounts for the T-stage lateralization of the primary tumor as well as clinical involvement as risk factors for occult contralateral involvement. In @sec-methods we describe how the model training and the computational experiments were set up.

3. In the results in @sec-results, we demonstrate that the model is able to describe the patterns of contralateral lymph node involvement observed in the dataset, and we apply the model to estimating risk of occult disease for typical patients. In @sec-discussion, implications for volume-deescalated radiotherapy are discussed.


# Data on Lymphatic Progression Patterns {#sec-data}

To be able to create models for lymphatic tumor progression that include all relevant LNLs including the contralateral side, we have collected a detailed dataset of {{< var data.num_patients >}} patients with newly diagnosed oropharyngeal squamous cell carcinomas [@ludwig_dataset_2022;@ludwig_multi-centric_2023]. It reports the lymph node involvement per LNL of every patient individually in tabular form, in addition to other primary tumor and patient characteristics such as T-category, subsite, lateralization of the primary tumor, and HPV p16 status. Their patient records have been collected at four different institutions and a brief overview over some of their patients' characteristics are shown in @tbl-data-overview. The data from the Inselspital Bern (ISB) and the Centre Léon Bérard (CLB) only consist of patients who all received a neck dissection. The majority of patients from the University Hospital Zürich (USZ) and the Hospital Vall d'Hebron (HVH) was treated with definitive radiotherapy. Since sugical treatment is more common for early T-category patients, the ISB and CLB datasets contain a larger portion of early T-category patients compared to the USZ and HVH dataset. For a subset of 83 patients in the CLB dataset, the lateralization of the primary tumor was not reported.

```{python}
#| echo: false
#| label: tbl-data-overview
#| tbl-cap: Overview over the five datasets from four different institutions used to train and evaluate our model. Here, we briefly characterize the total number of OPSCC patients from the respective institution, their median age, what proportion received some form of neck dissection, the N0 portion of patients, what percentage presented with early T-category, and the prevalence of primary tumor midline extension. For a much more detailed look at the data, visit [lyprox.org](https://lyprox.org).
from typing import Literal

def align(
  column: pd.Series,
  where: Literal["right", "left", "center"],
) -> list[str]:
  """Align a column."""
  return [f"text-align: {where}"] * len(column)

def right_align(column: pd.Series) -> list[str]:
  """Right align column."""
  return align(column, where="right")

def highlight(column: pd.Series, mapping: dict) -> list[str]:
  """Color based on `mapping`."""
  colors = column.map(mapping)
  return colors.map(lambda x: f"color: {x}")

def highlight_bool(
  column: pd.Series,
  c_false: str = COLORS["green"],
  c_true: str = COLORS["red"],
) -> list[str]:
  """Make cell read (`False`) or green (`True`)."""
  return highlight(column, mapping={True: c_true, False: c_false})

def highlight_t_stage(
  column: pd.Series,
  c_early: str = COLORS["green"],
  c_late: str = COLORS["red"],
) -> list[str]:
  """Highlight `early` and `late`."""
  is_early = column == "early"
  return highlight_bool(is_early, c_false=c_late, c_true=c_early)


col_map = {
  COL.inst: "Institution",
  COL.age: "Age",
  COL.nd: "Neck Dissection",
  COL.t_stage: "T-category",
  COL.n_stage: "N-category",
}
short_col_map = {tpl[-1]: val for tpl, val in col_map.items()}

raw = utils.load_patient_data(paths.data)
subdata = raw[col_map.keys()]
subdata.columns = subdata.columns.get_level_values(2)
subdata = (
  subdata
  .rename(columns=short_col_map)
  .reset_index(drop=True)
)

def n0_mean(n_stage: pd.Series) -> float:
  """Compute portion of N0 patients."""
  return (n_stage == 0).mean()

def early_mean(t_stage: pd.Series) -> float:
  """Compute early T-category portion."""
  return t_stage.isin([0,1,2]).mean()

grouped = (
  raw.groupby(
    by=COL.inst,
  ).aggregate(**{
    "Total": pd.NamedAgg(column=COL.age, aggfunc="count"),
    "Age (median)": pd.NamedAgg(column=COL.age, aggfunc="median"),
    "Neck Dissection": pd.NamedAgg(column=COL.nd, aggfunc="mean"),
    "N0": pd.NamedAgg(column=COL.n_stage, aggfunc=n0_mean),
    "Early T-Cat.": pd.NamedAgg(column=COL.t_stage, aggfunc=early_mean),
    "Mid. Ext.": pd.NamedAgg(column=COL.midext, aggfunc="mean"),
  }).convert_dtypes()
)
grouped.index.name = "Institution"
(
  grouped
  .reset_index()
  .style
  .format(
    formatter="{:>.0%}",
    subset=["Neck Dissection", "N0", "Early T-Cat.", "Mid. Ext."],
  )
  .apply(
    func=right_align,
    axis="index",
    subset=grouped.columns[0:],
  )
  .hide()
)
```


## Consensus on Involvement Status {#sec-data-consensus}

Pathological involvement is available only for the subset of surgical patients and only for the dissected levels. For the remaining patients, only clinical involvement is available. For the analysis performed in this paper, all available diagnostic information has been combined into a consensus decision representing the most likely state of involvement for each patient and LNL, using literature values for sensitivity and specificity of different modalities [@de_bondt_detection_2007;@kyzas_18f-fluorodeoxyglucose_2008]. How this consensus is formed is described in detail in @sec-consensus. In brief, pathology after neck dissection is taken as the ground truth if available, overwriting any contradicting clinical involvement diagnoses. If a level was not dissected, the most likely state is determined by PET-CT in most cases.


## Data Availability

The entire data, including additional patients with tumors in other primary locations than the oropharynx, is publicly available: It may be [downloaded from LyProX](https://lyprox.org/patients/dataset) where it can be interactively explored too, [from GitHub](https://github.com/rmnldwg/lydata), [from zenodo](https://zenodo.org/search?q=lydata), or via the *Data-in-Brief* publications @ludwig_dataset_2022 and @ludwig_multi-centric_2023. The Data-in-Brief publications contain a detailed description of the datasets and the data format. These publications do not include the most recent dataset addition from HVH, which will be described in a future publication.


## Patterns of Contralateral Involvement {#sec-data-strat}

These datasets allow us to investigate correlations between the involvement of individual LNLs, or between risk factors and involvement. In @fig-data-strat, we have plotted the prevalence of each contralateral LNL's involvement, stratified by the risk factors T-category, number of ipsilaterally involved LNLs, and whether the tumor extended over the mid-sagittal plane. 

![Contralateral involvement stratified by T-category (top left panel), the number of metastatic LNLs ipsilaterally (top right panel), and whether the primary tumor extended over the mid-sagittal line or was clearly lateralized (bottom left panel). Additionally, in the bottom right, we show that even for lateralized tumors, T-category and ipsilateral involvement are correlated with contralateral metastasis by comparing the contralateral involvement prevalence for selected scenarios that vary in their T-category and ipsilateral involvement extent.](figures/fig_data_strat.svg){#fig-data-strat}

The bottom left panel in @fig-data-strat shows that patients with a tumor crossing the mid-sagittal plane show contralateral involvement vastly more often compared to patients with clearly lateralized tumors. This makes intuitive sense, because the lymphatic system in the head and neck region is typically symmetric and no major lymph vessels cross the midline. Therefore, interstitial fluids from the primary tumor -- which we assume to carry living malignant cells -- may only reach the blind-ended lymphatic vessels in the contralateral neck via short-ranged diffusion. Which in turn is only possible when the primary tumor is close enough to the mid-sagittal line or crosses it. <!-- citation(s) needed? or is this intuition good enough? -->

The top left panel in @fig-data-strat indicates that T-category is correlated with contralateral involvement (as it is with overal involvement). This is because T-category may be considered a surrogate for the time between onset of disease and diagnosis. I.e., a patient with a T4 tumor was -- on average -- diagnosed later than a patient with a T1 tumor. Thus, the former did have more time to develop metastases.

Similarly, ipsilateral involvement correlates with contralateral metastasis (top right panel). The tumor of a patient with many metastases in ipsilateral LNLs was probably able to spread for longer (or faster) compared to a tumor in a patient with no nodal disease. The degree of ipsilateral involvement, too, may therefore be considered a surrogate for the duration of the disease. In addition, it has been hypothesized that bulky nodal disease ipsilaterally may also redirect lymph fluids to the contralateral side. <!-- citation needed? -->

The three risk factors for contralateral involvement, midline extension, T-category, and ipsilateral involvement are correlated. For example, midline extension was present in {{< var data.late_with_midext_percent >}}% of advanced T-category tumors but only in {{< var data.early_with_midext_percent >}}% of early T-category tumors. The higher prevalence of contralateral metastases in advanced T-category tumors may thus be partially explained by a higher rate of midline extension in these tumors. However, the bottom right panel of @fig-data-strat indicates that advanced T-category and severe ipsilateral involvement do represent additional risk factors. The figure considers only patients with lateralized tumors not extending over the midline. For early T-category and healthy ipsilateral levels I-V, only {{< var data.early_ipsin0_cII_percent >}}% ({{< var data.early_ipsin0_cII_match >}} out of {{< var data.early_ipsin0_cII_total >}} patients) shows involvement of contralateral level II. This increases to {{< var data.early_ipsiII_cII_percent >}}% ({{< var data.early_ipsiII_cII_match >}} out of {{< var data.early_ipsiII_cII_total >}} patients) if ipsilateral level II is involved, to {{< var data.early_ipsiIIandIII_cII_percent >}}% ({{< var data.early_ipsiIIandIII_cII_match >}} out of {{< var data.early_ipsiIIandIII_cII_total >}} patients) if ipsilateral levels II and III are involved, and to {{< var data.late_ipsiIIandIII_cII_percent >}}% ({{< var data.late_ipsiIIandIII_cII_match >}} out of {{< var data.late_ipsiIIandIII_cII_total >}} patients) for advanced T-category with ipsilateral levels II and III involved.


## Requirements for a Bilateral Model {#sec-requirements}

Based on the observations of the [previous section](#sec-data-strat), any model to predict the risk for contralateral nodal involvement, should be able to describe the following:

1. A tumor that extends over the mid-sagittal line should yield contralateral metastases with much higher probability.
2. More advanced T-category should lead to higher risk for nodal disease. One approach to achieve this via the expected time of diagnosis has already been developed in the form of a hidden Markov model [@ludwig_hidden_2021].
3. The degree of ipsilateral involvement should give the model information on the time that may have passed between onset and diagnosis of the disease. This should come in addition to what can be inferred about the time from T-category alone.

<!-- Over the course of this work, we will first briefly recap the HMM in @sec-unilateral, which was so far used to model ipsilateral lymphatic progression only. Then, we intuitively extend it to include the contralateral side as well in @sec-ext-to-contra. In this section, we also introduce a way of modelling the tumor's midline extension as a random variable (@sec-midline) and lastly talk about how it may affect the contralateral spread in @sec-params-symmetry. -->

<!-- TODO: Hint at methods and results... -->


# Unilateral Model for Lymphatic Progression {#sec-unilateral}

This paper builds on the previously developed unilateral model for ipsilateral lymph node involvement presented in [cite 2024 graph extension paper]. In this section we provide a brief recap of the unilateral model to introduce the notation needed to extend the framework to a bilateral model describing both ipsilateral and contralateral lymph node involvement in @sec-ext-to-contra. For further details in the ipsilateral model, the reader is referred to the earlier publications [@ludwig_hidden_2021, cite 2024 graph extension paper]

<!--
Our first model to predict the lymphatic progression of HNSCC was introduced using Bayesian networks [@pouymayou_bayesian_2019]. We subsequently extended this work to a hidden Markov model (HMM) [@ludwig_hidden_2021] to allow an intuitive inclusion of T-category into the predictions. We will briefly summarize this HMM's formalism before building on it to include the contralateral spread in @sec-ext-to-contra.
-->

We model a patient's state of involvement at an abstract time-step $t$ as a vector of hidden binary random variables:

$$
\mathbf{X}[t] = \begin{pmatrix} X_v[t] \end{pmatrix} \qquad v \in \left\{ 1, 2, \ldots, V \right\}
$$ {#eq-state-def}

Here, $V$ is the number of LNLs the model considers. The values a LNL's hidden binary random variables may take on are $X_v[t] = 0$ (`False`), meaning the LNL $v$ is healthy or free of metastatic disease, or $X_v[t] = 1$ (`True`), corresponding to some form of tumor presence (i.e., occult or clinically detected). Since the state vector $\mathbf{X}[t]$ is $V$-dimensional and binary, there are $2^V$ distinct possible lymphatic involvement patterns, which we enumerate from $\boldsymbol{\xi}_0 = \begin{pmatrix} 0 & 0 & \cdots & 0 \end{pmatrix}$ to $\boldsymbol{\xi}_{2^V} = \begin{pmatrix} 1 & 1 & \cdots & 1 \end{pmatrix}$. In addition, each LNL is associated with an observed binary random variable $Z_v$ that describes the clinical involvement of a LNL based on imaging: $Z_v = 0$ (`False`) indicates that the LNL $v$ is healthy based on clinical diagnosis, and $Z_v = 1$ (`True`) indicates that suspicious lymph nodes were detected that are deemed metastatic.

Any hidden Markov model is fully described by three quantities:

1. A starting state $\mathbf{X}[t=0]$ at time $t=0$ just before the patient's tumor formed. In our case, this is always the state where all LNLs are still healthy $\boldsymbol{\xi}_0$.
2. The *transition matrix*
   $$
   \mathbf{A} = \left( A_{ij} \right) = \big( P \left( \mathbf{X}[t+1] = \boldsymbol{\xi}_j \mid \mathbf{X}[t] = \boldsymbol{\xi}_i \right) \big)
   $$ {#eq-trans-matrix}
   where the value at row $i$ and column $j$ represents the probability to transition from state $\boldsymbol{\xi}_i$ to $\boldsymbol{\xi}_j$ during the time-step from $t$ to $t+1$. Note that we prohibit self-healing, meaning that during a transition, no LNL may change their state from $X_v[t]=1$ to $X_v[t+1]=0$. Consequently, many elements of the transition matrix are zero.
3. Lastly, the *observation matrix*
   $$
   \mathbf{B} = \left( B_{ij} \right) = \big( P \left( \mathbf{Z} = \boldsymbol{\zeta}_j \mid \mathbf{X}[t_D] = \boldsymbol{\xi}_i \right) \big)
   $$ {#eq-obs-matrix}
   where in row $i$ and at column $j$ we find the probability to *observe* a lymphatic involvement pattern $\mathbf{Z} = \boldsymbol{\zeta}_j$, given that the true (but hidden) state of involvement at the time of diagnosis $t_D$ is $\mathbf{X}[t_D] = \boldsymbol{\xi}_i$.

The transition matrix $\mathbf{A}$ is parametrized using a directed acyclic graph (DAG) as an abstract representation of the underlying lymphatic network. Directed arcs from the primary tumor to a LNL are associated with a probability $b_v$ for direct spread to LNL $v$ during one time step. Directed arcs from a LNL $v$ to a LNL $r$ are associated with a probability $t_{vr}$ for the tumor to progress from one LNL to the next. In this paper, we build on the DAG shown in @fig-full-graph which was obtained by maximizing the model evidence as described in [cite 2024 graph extension paper].

![Directed acyclic graph (DAG) representing the abstract lymphatic network in the head and neck region. Blue nodes are the LNLs' hidden random variables, the red node represents the tumor, and the orange square nodes depict the binary observed variables. Red and blue arcs symbolize the probability of lymphatic spread along that edge during one time-step. The orange arcs represent the sensitivity and specificity of the observational modality (e.g. CT, MRI, pathology, ...).](static/full-graph.svg){#fig-full-graph width=40%}

Using the introduced quantities, we can evolve the distribution of all possible hidden states from $\mathbf{X}[t=0] = \boldsymbol{\xi}_0$ step by step, by successively multiplying this vector with the transition matrix $\mathbf{A}$. For later use, we define at this point the matrices of the dsitributions over all hidden states, given all time-steps $\boldsymbol{\Lambda}$:

$$
\boldsymbol{\Lambda} = P \left( \mathbf{X} \mid \mathbf{t} \right) = \begin{pmatrix}
\boldsymbol{\pi}^\intercal \cdot \mathbf{A}^0 \\
\boldsymbol{\pi}^\intercal \cdot \mathbf{A}^1 \\
\vdots \\
\boldsymbol{\pi}^\intercal \cdot \mathbf{A}^{t_\text{max}} \\
\end{pmatrix}
$$ {#eq-lambda-matrix}

Where the $k$-th row in this matrix corresponds to the probability distribution over hidden states after $t=k-1$ time-steps.

At the time of the diagnosis $t_D$, we multiply the result with the observation matrix $\mathbf{B}$. We may then look up the likelihood of a patient presenting with the diagnosis $\mathbf{Z}=\boldsymbol{\zeta}_i$ in the $i$-th entry of the final result. However, the remaining issue is that the value of $t_D$ is unknown, i.e. over how many time-steps the HMM should be evolved. We solve this problem by marginalizing over the time of diagnosis. Different distributions over the diagnosis times can then be choosen based on T-category. For instance, the mean of the time-prior to marginalize over the diagnosis time for early T-category patients $P\left( t_D \mid \text{early} \right)$ may be shifted towards earlier times than the one for advanced T-category patients $P\left( t_D \mid \text{early} \right)$. This gives us for example

$$
P\left( \mathbf{X} \mid \text{T}x = \text{early} \right) = \sum_{t=0}^{t_\text{max}} P \left( \mathbf{X} \mid t \right) \cdot P(t \mid \text{early})
$$

In this work, we use binomial distributions $\mathfrak{B} \left( t_D, p_{\text{T}x} \right)$ as time-priors which have one free parameter $p_{\text{T}x}$ for each group of patients we differentiate based on T-category. Also, we fix $t_\text{max} = 10$, which means that the expected number of time-steps from the onset of a patient's disease to their diagnosis is $\mathbb{E}\left[ t_D \right] = 10 \cdot p_{\text{T}x}$.


## Likelihood Function of the Unilateral Model

With the formalism introduced above, we can write the likelihood function for a patient to present with a diagnosis consisting of an observed state and a T-category $d = \left( \boldsymbol{\zeta}_i, \text{T}x \right)$ as follows:

$$
\ell = P \left( \mathbf{Z} = \boldsymbol{\zeta}_i \mid \text{T}x \right) = \sum_{t=0}^{t_\text{max}} \left[ \boldsymbol{\xi}_0 \cdot \mathbf{A}^t \cdot \mathbf{B} \right]_i \cdot P \left( t \mid \text{T}x \right)
$$ {#eq-single-patient-llh}

Above, the quantity inside $\left[ \ldots \right]_i$ denotes the $i$-th component of the vector that is the result of the vector and matrix multiplications in the square brackets. Note that it is also possible to account for missing involvement information: If a diagnosis (like fine needle aspiration (FNA)) is only available for a subset of all LNLs, we can sum over all those possible complete observed states $\boldsymbol{\zeta}_j$ that match the provided diagnosis.

The single-patient likelihood $\ell$ in @eq-single-patient-llh depends on the spread parameters shown in @fig-full-graph via the transition matrix $\mathbf{A}$ and on the binomial parameters $p_{\text{T}x}$ via time-priors. In this work, we will only differentiate between "early" (T1 & T2) and "advanced" (T3 & T4) T-categories. Therefore, the parameter space of the unilateral model is:

$$
\boldsymbol{\theta} = \left( \left\{ b_v \right\}, \left\{ t_{vr} \right\}, p_\text{early}, p_\text{adv.} \right) \quad \text{with} \quad \genfrac{}{}{0pt}{2}{v\leq V}{r\in\operatorname{pa}(v)}
$$ {#eq-param-space}

And it is our goal to infer the values of these parameters for a given dataset $\mathcal{D} = \left( d_1, d_2, \ldots, d_N \right)$ of OPSCC patients. The likelihood of these $N$ diagnoses is simply the product of their individual likelihoods as defined in @eq-single-patient-llh. For numerical reasons, we typically compute the data likelihood in log space:

$$
\log \mathcal{L} \left( \mathcal{D} \mid \boldsymbol{\theta} \right) = \sum_{i=1}^N \log \ell_i
$$ {#eq-log-likelihood}

The methodology we use to infer the model's parameters is detailed in @sec-sampling.


# Extension to a Bilateral Model {#sec-ext-to-contra}

A naive approach to model the contralateral lymphatic spread would be to simply employ two independent unilateral models as introduced in @sec-unilateral. During training, one could enforce that some parameters are shared between these two models, e.g. the parameterization of the distributions over diagnose times or the spread among the LNLs ($t_{vr}). However, this approach lacks a way to describe the correlation between ipsi- and contralateral involvement discussed in section {#sec-data-strat}. Two independent unilateral models would not describe the observation that contralateral involvement becomes more likely with more severe ipsilateral involvement.

<!-- This is displayed in @tbl-data-strat and shows how often the contralateral LNLs I, II, III, and IV were involved, given all possible combinations of midline extension, T-category, and ipsilateral LNL III involvement. Unsurprisingly, the prevalence for contralateral involvement is consistently higher when the tumor extends over the mid-sagittal line or is of later T-category. But it is also more frequent when the ipsilateral side shows more severe involvement, which is here shown via the surrogate LNL III. -->

<!-- Additionally, we could think of an approach to incorporate the primary tumor's mid-sagittal extension as a risk factor. -->

Thus, we extend the formalism in @sec-unilateral in such a way that the model's ipsi- and contralateral side evolve synchronously over time. To achieve that, we start by writing down the posterior distribution of involvement an analogy to @eq-uni-bayes-law, which is now a joint probability of an involvement $\mathbf{X}^\text{i}$ ipsilaterally *and* an involvement $\mathbf{X}^\text{c}$ contralaterally, given a diagnosis of the ipsilateral LNLs $\mathbf{Z}^\text{i}$ and of the contralateral ones $\mathbf{Z}^\text{c}$:

$$
P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \mid \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c} \right) = \frac{P \left( \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c} \mid \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \right) P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \right)}{P \left( \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c} \right)}
$$ {#eq-bilateral-bayes}

For the sake of brevity, we omit the dependency on the parameters and the T-category here.

The probability of the diagnoses given a hidden state factorises: $P \left( \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c} \mid \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \right) = P \left( \mathbf{Z}^\text{i} \mid \mathbf{X}^\text{i} \right) \cdot P \left( \mathbf{Z}^\text{c} \mid \mathbf{X}^\text{c} \right)$, and the two factors are described through observation matrices $\mathbf{B}^\text{i}$ and $\mathbf{B}^\text{c}$.

The term representing the model's prior probability of hidden involvement does not factorize. However, we assume that there is no direct lymph drainage from an ipsilateral LNL to a contralateral LNL. No major lymph vessels cross the mid-sagittal plane. In the graphical model, this means that we assume no directed arcs between ipsilateral and contralateral LNLs, i.e. tumor spread to the contralateral side is due to the primary tumor alone. We can thus write the joint probability $P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \right)$ as a factorising sum:

$$
\begin{aligned}
P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \right) &= \sum_{t=0}^{t_\text{max}} P(t) \cdot P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \mid t \right) \\
&= \sum_{t=0}^{t_\text{max}} P(t) \cdot P \left( \mathbf{X}^\text{i} \mid t \right) \cdot P \left( \mathbf{X}^\text{c} \mid t \right)
\end{aligned}
$$ {#eq-bilateral-marginal}

This assumption makes intuitive sense: The state of the ipsilateral and contralateral sides of the lymphatic network evolves independently over time as there are no major lymph vessels crossing the midline. However, both sides are coupled via time. Qualitatively speaking, according to the model in {#eq-bilateral-marginal}, a joint state with severe contralateral involvement and limited ipsilateral involvement would be unlikely, because severe contralateral involvement becomes likely only at later time steps when limited ipsilateral involvement becomes unlikely.

<!-- There may, however, be diffusion of lymph fluid accross this line or bulky involvement that redirects lymphatic drainage significantly.-->

Using @eq-bilateral-marginal along with @eq-lambda-matrix, we can write the above distribution algebraically as a product:

$$
P \left( \mathbf{X}^\text{i} = \boldsymbol{\xi}_n, \mathbf{X}^\text{c} = \boldsymbol{\xi}_m \right) = \left[ \boldsymbol{\Lambda}^\intercal_\text{i} \cdot \operatorname{diag} P(\mathbf{t}) \cdot \boldsymbol{\Lambda}_\text{c} \right]_{n,m}
$$ {#eq-bilateral-marginal-algebra}


## Parameter Symmetries {#sec-params-symmetry}

In general, the matrices $\boldsymbol{\Lambda}_\text{i}$ and $\boldsymbol{\Lambda}_\text{c}$ could be parameterized using a disjoint set of parameters, i.e., the ipsi- and contralateral spread rates are entirely different. However, using three sensible assumptions, we can reduce the parameter space by sharing some parameters between the two sides:

1. We assume that both ipsilateral and contralateral spread is described through the same graph shown in {#fig-full-graph}.
2. We assume the spread *among* the LNLs to be same on both sides. It is reasonable to assume the lymphatic system is symmetric. Thus, the spread rates from one LNL to the other should be symmetric, too. Formally, this means \
   $$
   \begin{aligned}
   b_v^\text{c} &\neq b_v^\text{i} \\
   t_{rv}^\text{c} &= t_{rv}^\text{i}
   \end{aligned}
   $$ {#eq-symmetries}
   for all $v \leq V$ and $r \in \operatorname{pa}(v)$.
3. The tumor's spread to the contralateral side in case of an extension over the midline is larger than if it was clearly lateralized, but smaller than its spread to the ipsilateral side. This assumption stems from a simple thought experiment: Consider moving the tumor from a clearly lateralized position accross the mid-sagittal plane to the same position, but on the contralateral side. In the beginning we would have $b_v^\text{c} < b_v^\text{i}$, while in the end, the situation is reversed. If a tumor extends over the mid-sagittal line, its contralateral spread rate can be expected to be in between these two extremes. We encode this in a *mixing parameter* $\alpha \in [0,1]$ that captures a "degree of asymmetry": \
   $$
   b_v^{\text{c},\epsilon=\texttt{True}} = \alpha \cdot b_v^\text{i} + (1 - \alpha) \cdot b_v^{\text{c},\epsilon=\texttt{False}}
   $$ {#eq-mixing}
   This means the model now uses three different sets of parameters to describe the spread from the tumor to the LNLs: $b^\text{i}_v$ for the spread to the ipsilateral LNLs, $b_v^{\text{c},\epsilon=\texttt{False}}$ for the spread to the contralateral LNLs as long as the tumor is clearly lateralized, and finally $b_v^{\text{c},\epsilon=\texttt{True}}$ when it crosses the midline. Note, however, that these three sets of spread rates only account for $2 \cdot 2^V + 1$ parameters, since they are coupled via the mixing parameter $\alpha$.

Our parameter space has now expanded to

$$
\boldsymbol{\theta} = \left( \left\{ b_v^\text{i} \right\}, \left\{ b_v^\text{c} \right\}, \alpha, \left\{ t_{vr} \right\}, p_\text{early}, p_\text{adv.} \right) \quad \text{with} \quad \genfrac{}{}{0pt}{2}{v\leq V}{r\in\operatorname{pa}(v)}
$$ {#eq-bi-param-space}

which is less than double in size, compared to the unilateral model. From these parameters, we now build three different transition matrices: The unchanged matrix $\mathbf{A}_\text{i}$ for the ipsilateral side, one $\mathbf{A}_\text{c}^{\epsilon=\texttt{False}}$ for the contralateral side that covers the progression as long as the tumor is lateralized, and $\mathbf{A}_\text{c}^{\epsilon=\texttt{True}}$ in case of a tumor that has crossed the mid-sagittal line.


## Modelling Midline Extension {#sec-midline}

It can be assumed that most tumors that cross the midline at the time of diagnose have started as lateralized tumors and grew over the midline at a later time step. Hence, the transition matrix $\mathbf{A}_\text{c}^{\epsilon=\texttt{True}}$ only applies for a subset of the time steps.
Therefore, we also model the tumor's extension over the mid-sagittal line as a binary random variable. A tumor starts lateralized and at every time-step there is a finite probability $p_\epsilon$ that the tumor grows over the midsaggital plane. The overall probabilities to find a patient with a clearly lateralized tumor or one that extends over the mid-sagittal line after $t$ time-steps are then respectively given by

$$
\begin{aligned}
P(\epsilon = \texttt{False} \mid t) &= (1 - p_\epsilon)^t \\
P(\epsilon = \texttt{True} \mid t) &= 1 - P(\epsilon = \texttt{False} \mid t)
\end{aligned}
$$

Using this, it is straightforward to write down the matrix of state distributions for all time-steps, as in @eq-lambda-matrix covering the contralateral hidden state evolution:

$$
\boldsymbol{\Lambda}_\text{c}^{\epsilon=\texttt{False}} =
\left(
\begin{array}{r}
\boldsymbol{\pi}^\intercal \cdot \left( \mathbf{A}_\text{c}^{\epsilon=\texttt{False}} \right)^{0\phantom{t_\text{max}}} \\
(1-p_\epsilon) \cdot \boldsymbol{\pi}^\intercal \cdot \left( \mathbf{A}_\text{c}^{\epsilon=\texttt{False}} \right)^{1\phantom{t_\text{max}}} \\
\hfill \vdots \hfill \\
(1-p_\epsilon)^{t_\text{max}} \cdot \boldsymbol{\pi}^\intercal \cdot \left( \mathbf{A}_\text{c}^{\epsilon=\texttt{False}} \right)^{t_\text{max}\phantom{0}} \\
\end{array}
\right)
$$

where we used the transition matrix $\mathbf{A}_\text{c}^{\epsilon=\texttt{False}}$ that depends on the base spread parameters $b_v^{\text{c},\epsilon=\texttt{False}}$.

The case when midline extension is eventually present is more complicated: We already marginalize over the exact time-step when the tumor grows over the mid-sagittal line. But whenever that happens, we also need to change the contralateral transition matrix to use the increased spread rates $b_v^{\text{c}, \epsilon=\texttt{True}}$ from the tumor to the contralateral LNLs, given by the linear mixing in @eq-mixing. We can achieve the correct marginalization by iteratively building the joint distribution $P \left( \mathbf{X}^\text{c}, \epsilon=\texttt{True} \mid t \right)$. We start from $t=0$, where we know that all LNLs are healthy (the contralateral neck is in the state $\mathbf{X}_\text{c}=\boldsymbol{\xi}_0$) and the tumor is lateralized ($\epsilon=\texttt{False}$):

$$
P \left( \mathbf{X}^\text{c} = \boldsymbol{\xi}_0, \epsilon=\texttt{False} \mid t=0 \right) = 1
$$

whereas all other states have zero probability. Then we consider an arbitrary later time-step $t=\tau+1$. There are two possible scenarios we need to marginalize over:

1. The tumor was still lateralized at $t=\tau$ and just grew over the midline. Under this scenario, the probability for having a midline extension at $t=\tau+1$ is given by $p_\epsilon$. We use this to weight the contralateral state distribution that was so far evolved without increased contralateral spread.
2. The mid-sagittal line was already crossed by the tumor. In that case, the probability is 1 to remain in that lateralization state. Thus, to account for this case we simply add the distribution $P\left( \mathbf{X}^\text{c}, \epsilon=\texttt{True} \mid \tau \right)$ from one time-step earlier, arriving at a recursion relation:

$$
P \left( \mathbf{X}^\text{c}, \epsilon=\texttt{True} \mid \tau + 1 \right) = \big[ p_\epsilon P \left( \mathbf{X}^\text{c}, \epsilon=\texttt{False} \mid \tau \right) + P \left( \mathbf{X}^\text{c}, \epsilon=\texttt{True} \mid \tau \right) \big]^\top \cdot \mathbf{A}_\text{c}^{\epsilon=\texttt{True}}
$$

We can collect the iteratively computed distributions for the midline extension case to define the matrix over the states given all time-steps, in analogy to @eq-lambda-matrix:

$$
\boldsymbol{\Lambda}_\text{c}^{\epsilon=\texttt{True}} = \begin{pmatrix}
P \left( \mathbf{X}^\text{c}, \epsilon=\texttt{True} \mid 0 \right) \\
P \left( \mathbf{X}^\text{c}, \epsilon=\texttt{True} \mid 1 \right) \\
\vdots \\
P \left( \mathbf{X}^\text{c}, \epsilon=\texttt{True} \mid t_\text{max} \right) \\
\end{pmatrix}
$$

Using this, we can again write the joint of ipsi- and contralateral involvement - now also for the case of mid-sagittal extension - algebraically as before in @eq-bilateral-marginal-algebra:

$$
P \left( \mathbf{X}^\text{i} = \boldsymbol{\xi}_n, \mathbf{X}^\text{c} = \boldsymbol{\xi}_m, \epsilon \right) = \left[ \boldsymbol{\Lambda}^\intercal_\text{i} \cdot \operatorname{diag} P(\mathbf{t}) \cdot \boldsymbol{\Lambda}_\text{c}^\epsilon \right]_{n,m}
$$

We can use this term to compute the likelihood of all patients with and without midline extension separately. And if for some patients the information of tumor lateralization is not available, we can simply sum the above term once for $\epsilon=\texttt{False}$ and once for $\epsilon=\texttt{True}$ to marginalize over the unknown variable.

The final parameter space of our extended model has now reached this size:

$$
\boldsymbol{\theta} = \left( \left\{ b_v^\text{i} \right\}, \left\{ b_v^\text{c} \right\}, \alpha, \left\{ t_{vr} \right\}, p_\text{early}, p_\text{adv.}, p_\epsilon \right) \quad \text{with} \quad \genfrac{}{}{0pt}{2}{v\leq V}{r\in\operatorname{pa}(v)}
$$ {#eq-ext-param-space}


## Model Prediction in the Bayesian Context

Our stated goal is to compute the risk for a patient's true ipsi- and contralateral nodal involvement states $\mathbf{X}^\text{i}$ and $\mathbf{X}^\text{c}$, *given* their individual diagnosis $d = \left( \boldsymbol{\zeta}^\text{i}_k, \boldsymbol{\zeta}^\text{c}_\ell, \epsilon, \text{T}x \right)$. Here, this diagnosis consists of the observed ipsi- and contralateral nodal involvements, the patient's midline extension $\epsilon$, and their tumor's T-category $\text{T}x$. Using Bayes' law, we can write this risk as:

$$
P \big( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \mid d, \boldsymbol{\hat{\theta}} \big)
= \frac{P \left( \boldsymbol{\zeta}^\text{i}_k \mid \mathbf{X}^\text{i} \right) P \left( \boldsymbol{\zeta}^\text{c}_\ell \mid \mathbf{X}^\text{c} \right) P \big( \mathbf{X}^\text{i}, \mathbf{X}^\text{c}, \epsilon \mid \boldsymbol{\hat{\theta}}, \text{T}x \big)}
{\sum_{i=0}^{2^V} \sum_{j=0}^{2^V} \mathcal{C}_{ij}}
$$ {#eq-uni-bayes-law}

with the normalization constants

$$
\mathcal{C}_{ij} = P \left( \boldsymbol{\zeta}^\text{i}_k \mid \mathbf{X}^\text{i}=\boldsymbol{\xi}^\text{i}_i \right) P \big( \boldsymbol{\zeta}^\text{c}_\ell \mid \mathbf{X}^\text{c}=\boldsymbol{\xi}^\text{c}_j \big) P \big( \mathbf{X}^\text{i}=\boldsymbol{\xi}^\text{i}_i, \mathbf{X}^\text{c}=\boldsymbol{\xi}^\text{c}_j, \epsilon \mid \boldsymbol{\hat{\theta}}, \text{T}x \big)
$$

The terms $P \left( \boldsymbol{\zeta}^\text{i}_k \mid \mathbf{X}^\text{i} \right)$ and $P \left( \boldsymbol{\zeta}^\text{c}_\ell \mid \mathbf{X}^\text{c} \right)$ are defined solely by sensitivity and specificity of the diagnostic modality. Terms like these already appeared in the definition of the observation matrx in @eq-obs-matrix. The *prior* $P \big( \mathbf{X}^\text{i}, \mathbf{X}^\text{c}, \epsilon \mid \boldsymbol{\hat{\theta}}, \text{T}x \big)$ in the above equation is the crucial term that is supplied by a trained model and its parameters $\boldsymbol{\hat{\theta}}$.

It is possible to compute this *posterior* probability of true involvement not only for one fully defined state $(\mathbf{X}^\text{i}, \mathbf{X}^\text{c})$, but also for e.g. individual LNLs: For example, the risk for involvement in the contralateral level IV would be a marginalization over all ipsilateral states $\boldsymbol{\xi}^\text{i}_i$ and all contralateral states $\boldsymbol{\xi}^\text{c}_j$ where $\xi^\text{c}_{j4}=1$. Formally:

$$
P \big( \text{cIV} \mid \mathbf{Z}^\text{i}=\boldsymbol{\zeta}^\text{i}_k, \mathbf{Z}^\text{c}=\boldsymbol{\zeta}^\text{c}_\ell, \boldsymbol{\hat{\theta}}, \text{T}x \big) = \sum_k \sum_{\ell \, : \, \xi_{\ell 4}=1} P \big( \mathbf{X}^\text{i} = \boldsymbol{\xi}^\text{i}_k, \mathbf{X}^\text{c} = \boldsymbol{\xi}^\text{c}_\ell \mid \boldsymbol{\zeta}^\text{i}_k, \boldsymbol{\zeta}^\text{c}_\ell, \epsilon, \boldsymbol{\hat{\theta}}, \text{T}x \big)
$$ {#eq-marg-over-posterior}


# Computational methods {#sec-methods}

<!-- Maybe I should break this apart into separate chapters on data, sampling, etc. -->

In this section, we detail how the experiments were performed. Every figure, table, and result is fully reproducible via the GitHub repository [`rmnldwg/bilateral-paper`]. It also contains the raw manuscript and instructions on how to recreate all figures, tables, and the final document.

[`rmnldwg/bilateral-paper`]: https://github.com/rmnldwg/bilateral-paper


## Involvement Data Consensus {#sec-methods-consensus}

It is possible to provide our model with multiple different diagnostic modalities, each being characterized by different pairs of sensitivity and specificity. However, we instead chose to combine them into a single "consensus" diagnosis before parameter inference, as introduced in @sec-data-consensus. We opted for this because the literature values of sensitivity and specificity [@de_bondt_detection_2007;@kyzas_18f-fluorodeoxyglucose_2008] of imaging modalities like MRI and CT do not plausibly match some of our observations: In the USZ cohort, 78% of OPSCC patients where diagnosed with ipsilateral LNL II involvement via diagnostic imaging. This is virtually impossible with sensitivities around 80% and specificities lower than 100%.


## MCMC Sampling {#sec-sampling}

For parameter inference, we used the Python package [`emcee`] [@foreman-mackey_emcee_2013]. It implements efficient MCMC sampling algorithms that employ multiple parallel samplers for affine invariance and better performance on multi-core CPUs. The sample proposal algirothms used by us are based on differential evolution moves [@ter_braak_differential_2008;@nelson_run_2013]. The [`emcee`] library was provided with the likelihood implemented by our [`lymph-model`] Python package.

For each dimension in the parameter space of the model, we initialized {{< var sampling.walkers_per_dim >}} of these parallel samplers, called "walkers", with random values in the unit cube. Every time all of these walkers advanced {{< var sampling.check_interval >}} steps, the autocorrelation time of the chains was estimated. For short chains, this estimate is not trustworthy, but stabilizes for longer chains. We therefore considered a sampling to be converged when two criteria were met:

1. The change in the autocorrelation time was less then {{< var sampling.rel_thresh >}}.
2. The estimate of the autocorrelation dropped below $n$ / {{< var sampling.trust_fac >}} where $n$ is the length of the chain up to that point.

All samples up to this convergence - called the *burn-in phase* - were discarded. We only kept another {{< var sampling.nsteps >}} samples after that, which were spaced {{< var sampling.thin >}} steps apart.

[`emcee`]: https://emcee.readthedocs.io/en/stable/
[`lymph-model`]: https://lymph-model.readthedocs.io/en/stable/

First, in @fig-model-burnin-history, we verify the sampling converged successfully by inspecting two monitoring quantities: The autocorrelation time of the MCMC chain and the acceptance fractions of the parallel walkers.

![Monitoring quantities during the burn-in phase of the parameter sampling. Left: The autocorrelation time of the sampling chain estimated at different sampling steps. We consider the chain converged when the estimate of the autocorrelation time is stable and drops below the trust threshold of $n/50$ where $n$ is the number of steps. Right: Fraction of accepted MCMC proposals averaged over all parallel walkers. Values around 30% indicate good mixing of the walkers.](figures/fig_model_burnin_history.svg){#fig-model-burnin-history}



## Computing the Observed and Predicted Prevalence of Involvement Patterns {#sec-prevalence}

We want to assess the model's capability to approximate the distribution of lymphatic involvement patterns seen in the data. To that end, we compare the prevalence of some invovlement patterns under selected scenarios with the model's prediction for how often these involvements it expects to see, given these scenarios.

In this context, a "scenario" includes the patient's T-category $\text{T}x$ and whether the patient's tumor extended over the mid-sagittal line, i.e. $\epsilon=\texttt{True}$ or $\epsilon=\texttt{False}$.

An involvement pattern specifies for each ipsi- and contralateral LNL whether it is "healthy", "involved", or "masked". If it is "masked", we essentially state that we are not interested in the involvement of that LNL and the prevalence will be marginalized over this LNL's involvement.

For example, we may be interested in the prevalence of contralateral LNL II involvement (i.e., contra LNL II "involved" and all other LNLs "masked") under the scenario of early T-category (T0-T2) and no midline extension ($\epsilon=\texttt{False}$). To compute this prevalence in the data, we select all patients of this scenario (in our data, this amounts to {{< var data.early_nomidext_cII_total >}} patients). Of those, {{< var data.early_nomidext_cII_match >}} were found to harbor metastases in their contralateral LNL II. Therefore, the prevalence is {{< var data.early_nomidext_cII_percent >}}%.

When displaying this data prevalence, we often choose to draw a *beta posterior* over the "true" prevalence, hinting at the fact that our data merely represents a limited sample. The beta posterior follows from a uniform beta distribution as prior and a binomial likelihood for the number of patients with the involvement of interest, given the parameer for the "true" prevalence. The resulting distribution has its maximum at the observed prevalence, but in addition gives a visual intuition for the variance of of the observed quantity. I.e., when we observe 3 out of 10 events, the beta posterior is much wider than if we observe 300 out of 1000 for he same prevalence. It also allows us to check not only if the model is accurate, but also whether it reflects the uncertainty contained in the data.

Predicting the prevalence using our model amounts to computing the following probability:

$$
P \left( \text{II}^\text{c} \mid \epsilon=\texttt{False}, \text{T}x=\text{early} \right) = \frac{P \left( \text{II}^\text{c}, \epsilon=\texttt{False} \mid \text{T}x=\text{early} \right)}{P \left( \epsilon=\texttt{False} \mid \text{T}x=\text{early} \right)}
$$

In the enumator, we marginalize over all ipsi- and contralateral LNLs' involvements, except for LNL II contralaterally. This is similar to the marginalization in @eq-marg-over-posterior, although we are summing over different quantities. In the denominator, we can simply insert the joint distribution over midline extension and diagnose time $P \left( \epsilon, t \right)$ marginalized over $t$ using the early T-category's time-prior.

Since we compare it to the data, which does not report true but only observed involvement -- although pathologically investigated LNLs may be as close as possible to the ground truth -- we do not consider posteriors of the form $P \left( \mathbf{X} \mid \mathbf{Z} \right)$ here. Instead, we compute probabilities of observed involvement $P \left( \mathbf{Z} \right)$, as in the likelihood @eq-single-patient-llh.

When plotted, we usually display histograms over the model's predictions. Each of their values was computed from a different parameter set drawn during MCMC sampling, effectively giving us a distribution over the prevalences. Ideally, the histograms approximate the location and width of the Beta posteriors when attempting to describe the data they were trained on.

Note that we decided to omit the y-axis ticks and labels in these figures over prevalences and risks. The y-axis in these plots measures the probability density and its numerical values are not intuitively interpretable. Instead, we occasionally use the freed space to label e.g. rows of subplots.


# Results: Model evaluation {#sec-results}

In @tbl-midline-params, we tabulate the mean and standard deviation of the sampled parameters for the full midline model. Considering the parameters of the bilateral model that describe the ipsilateral spread ($b^i_v$, $t_{vr}$ and $p_\text{adv.}$), we note that the bilateral model mostly reproduces the parameter values reported in the earlier publication [@ludwig_modelling_2023] for the unilateral model. The small differences may be mostly due to the differences in the training dataset. Therefore, the analysis of the model's capability to adequately describe ipsilateral lymph node involvement is not repeated here and we focus instead on the analysis of contralateral involvement. We can further note that the contralateral spread parameters $b^c_v$ are small compared to the ipsilateral parameters $b^i_v$, reflecting the low prevalence of contralateral lymph node involvement for lateralized tumors.

```{python}
#| echo: false
#| label: tbl-midline-params
#| tbl-cap: Mean sampled parameter estimates of the midline model and the respective standard deviation. The parameters set to fixed values are the maximum number of time steps $t_{max}=10$ and the time prior parameter for early T-category patients $p_{early}=0.3$.
def map_param_names(name: str) -> str:
  """Make parameter names more readable."""
  try:
    return {
      "midext_prob": "Mid. ext. probability",
      "mixing": "Mixing ⍺",
      "late_p": "late T-cat. binom. prob.",
    }[name]
  except KeyError:
    return re.sub(
      r"(ipsi|contra)_", r"\g<1>: ", name
    ).replace(
      "to", " ➜ "
    ).replace(
      "_spread", ""
    )

model = shared.get_model(which="full", load_samples=True)
samples = shared.get_samples(which="full")

names = [map_param_names(p) for p in model.get_params()]
means, stds = samples.mean(axis=0), samples.std(axis=0)

early_midext_prob = model.state_dist(t_stage="early")[1].sum()
late_midext_prob = model.state_dist(t_stage="late")[1].sum()

params_table = pd.DataFrame({"Parameter": names, "Mean": means, "Std. Dev.": stds})
(
  params_table.style
  .format("{:.2%}", subset=["Mean"])
  .format("± {:.2%}", subset=["Std. Dev."])
  .apply(right_align, subset=["Mean", "Std. Dev."])
  .hide()
)
```

## Illustration of the model

In this subsection we illustrate parts of the mathematical framework defined in the previous section. In @fig-model-midext-evo (top panel), we visualize the prior distribution over diagnose times $P(t)$. By parameter choice, early T-category tumors are diagnosed on average after {{< var model.early_expected_time >}} time steps. Advanced T-category tumors are diagnosed on average after {{< var model.late_expected_time >}} time steps, because the parameter $p_\text{adv.}$ was learned to be {{< var model.params_percent.late_p >}}% for advanced T-category tumors. The probability per time step for the tumor to grow over the midline ($p_\epsilon$) was on average {{< var model.params_percent.midext_prob >}}%. Using this, one can compute the probability of midline extension $P(\epsilon \mid t)$ at a given time step $t$ (red line in @fig-model-midext-evo). The bottom panel in this figure shows the joint probability $P(\epsilon, t)$ to be diagnosed at time step $t$ with a given state of midline extension and T-category.

![The top panel shows the prior probability to get diagnosed at time-step $t$ for early and late T-category tumors as bars. Also in the top panel, we plot the conditional probability of the tumor's midline extension ($\epsilon=\texttt{True}$), given the time-step $t$ as a line plot. In the bottom panel, we show the joint probability of getting diagnosed in time-step $t$ *and* having a tumor that crosses the midline.](figures/fig_model_midext_evo.svg){#fig-model-midext-evo width="50%"}

The model introduced in the previous section defines a model of the joint probability distribution over midline extension and ipsi- and contralateral lymph node involvement, $P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c}, \epsilon \right)$. How this quantity is computed is illustrated in @fig-model-algebra-equation, visually representing @eq-bilateral-marginal-algebra. To keep it manageable to interpret, this example only considers the LNLs II, III, and IV ipsi- and contralaterally, resulting in $2^3 = 16$ distinct states per side and thus $2 \times 8 \times 8 = 128$ total states. LNLs I, V, and VII and the associated spread parameters have been removed from the model while the remaining parameters are set to the mean values in @tbl-midline-params. 

![Visual representation of @eq-bilateral-marginal-algebra for the case of midline extention. The left and right matrices represent the evolution of the possible hidden states for the ipsi- and contralateral neck respectively. In particular, the right matrices describe the evolution of the contralateral hidden states once for the case of no midline extension (top) and once for the case where the tumor does extend over the mid-sagittal line (bottom). In the center, the time-prior for late T-category is plotted as a diagonal matrix. The result of this matrix computation is the joint distribution $P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c}, \epsilon \right)$, visualized in @fig-model-state-dist](figures/fig_model_algebra_equation.svg){#fig-model-algebra-equation}

The matrix on the left side of @fig-model-algebra-equation shows the time evolution of the probability distribution over the ipsilateral involvement state, starting from the healthy state $[0,0,0]$ with probability one. The two matrices on the right side show the time evolution of the probability distribution over the contralateral involvement state, where we need to distinguish the two cases with and without midline extension. At time step $t=0$, the contralateral neck starts from the healthy state $[0,0,0]$ without midline extension. The matrix in the center shows the time prior for late T-category. The result of the matrix multiplication is the joint probability distribution over midline extension and ipsi- and contralateral lymph node involvement, $P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c}, \epsilon=\texttt{True} \right)$ shown in figure @fig-model-state-dist. The joint distribution is shown as two separate heatmaps for the two midline extension states. The most likely state is a lateralized tumor with involvement of ipsilateral level II and no contralateral involvement, which has a probability of approximately 25%. The second most probable state is a lateralized tumor with ipsilateral involvement of levels II and III and no contralateral involvement. The most likely state with contralateral involvement are tumors with midline extension with involvement of contralateral level II and ipsilateral level II and III.

![The full distribution $P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c}, \epsilon=\text{False} \right)$ over the ipsi- and contralateral states, as well as midline extension as computed by a model considering the LNLs II, III, and IV for a late T-category tumor. Since this is a three-dimensional object with one dimension being the binary random variable representing midline extension $\epsilon$, we show this distribution as separate two-dimensional heatmaps. These two matrices are the result of @eq-bilateral-marginal-algebra, which we visualized as well in @fig-model-algebra-equation.](figures/fig_model_state_dist.svg){#fig-model-state-dist}


## Prevalence predictions for contralateral involvement

The bilateral model was designed to fulfil the requirements laid out in @sec-requirements. Now, we investigate to what extent the model can quantitatively describe the patterns of lymph node involvement observed in the dataset. To that end, we compare the model's predictions for contralateral involvement against observations in the data. This is done given scenarios that differ in T-category and/or midline extension and/or ipsilateral involvement.


### Dependence of Contralateral Involvement on T-Category and Midline Extension

In @fig-model-prevalences-overall, we plot the prevalence of contralateral involvement of the LNLs II, III, and IV for the four scenarios made up of the possible combinations of early and late T-category, as well as lateralized and midline extending tumors.

![Comparison of predicted (histograms) vs observed (beta posteriors) prevalences, shown for the contralateral LNLs II (blue), III (orange), and IV (green). The top row shows scenarios with early T-category tumors, the bottom row for late T-category ones. The left column depicts scenarios where the primary tumor is clearly lateralized, the right column scenarios of tumors extending over the mid-sagittal line. This figure illustrates the model's ability to describe the prevalence of involvement for different combinations of the risk factors T-category and midline extension.](figures/fig_model_prevalences_overall.svg){#fig-model-prevalences-overall}

@Fig-model-prevalences-overall shows that the model is capable of accurately accounting for the most important risk factors, i.e. T-category and midline extension. As observed in the data, the model predicts that the prevalence of contralateral LNL II involvement increases from {{< var prevalence.early_noext_iN0_cII.predicted >}}% for early T-category lateralized tumors to {{< var prevalence.late_ext_iN0_cII.predicted >}}% when the tumor is of advanced T-category and crosses the mid-sagittal line. Similarly, the prevalence of contralateral LNL III involvement increases from around {{< var prevalence.early_noext_iN0_cIII.predicted >}}% for early T-category lateralized tumors to almost {{< var prevalence.late_ext_iN0_cIII.predicted >}}% when the tumor is of advanced T-category and crosses the mid-sagittal line.

<!-- However, for early T-category scenarios with midline extension, the model does seem to overestimate contralateral LNL II and III invovlement. This likely stems from the the small sample size of this relatively rare scenario as hinted at by the wide beta posteriors. -->


### Influence of Upstream Involvement on Contralateral Metastasis

![The influence of the upstream LNL II's involvement on the prevalence of contralateral level III for the four combinations of tumor lateralization (lateralized or extending over midline) and T-ctageory (early or advanced). Our model predictions (histograms) are plotted against the observations in the data (beta posteriors).](figures/fig_model_prevalences_upstream.svg){#fig-model-prevalences-upstream}

@Fig-model-prevalences-upstream illustrates how rarely the contralateral LNL III harbors metastases when its upstream level II is healthy. Also, the model can capture this correlation rather well, with the exception of early T-category tumors that extend over the mid-sagittal line. As in @fig-model-prevalences-overall and @fig-model-prevalences-with-ipsi, these cases are relatively rare resulting in a broad distribution over the true prevalence.


### Correlation between Ipsi- and Contralateral Involvement

![Comparison of the computed and observed prevalences for scenarios that illustrate the model's capability of accounting for the correlation between ipsi- and contralateral involvement. We show three scenarios where we consider the joint involvement of contralateral LNL II together with different ipsilateral involvements: 1) the ipsilateral neck shows no involvement in blue (LNLs I to V are healthy, LNL VII is unspecified because data on it is missing for some patients), 2) where ipsilateral LNL II is involved in orange (LNLs I, III, IV, and V are healthy), and 3) where ipsilateral LNLs II and III are involved in orange (LNLs I, IV, and V are healthy). These two scenarios are plotted for all combinations of T-category (early in top row, advanced in bottom row) and tumor lateralization (lateralized in left column, extending over mid-sagittal line in the right column).](figures/fig_model_prevalences_with_ipsi.svg){#fig-model-prevalences-with-ipsi}

In @fig-model-prevalences-with-ipsi we display the model's ability to capture the correlation between ipsi- and contralateral involvement. Shown are marginals of the joint distribution where we consider contralateral LNL II involvement with simulaneous involvement of different ipsilateral LNLs. The model has no direct connections between the two sides and thus no adjustable parameter to specifically quantify correlations between ipsi- and contralateral involvement. Metastases in the two sides of the neck are only correlated via the time of diagnosis. Nevertheless, the model adequately predicts that contralateral level II involvement is rare in combination with a healthy ipsilateral neck (green histograms). If ipsilateral LNL II is involved, contralateral involvement is more frequent. 

<!-- However, there are some discrepancies in the model's prediction: It cannot quite capture the correlation of ipsi- and contralateral involvement that is seen in the data. This is notable for example in the bottom right subplot where the prevalence is overestimated for the scenario of an (almost) healthy ipsilateral neck and underestimated when at least LNL III shows metastases. One reason for this may be the width of the time-prior: If it was wider, the posterior over the diagnosis time given the ipsilateral involvement could more flexibly shift to reflect a more severe contralateral involvement. -->

<!-- NOTE: This last sentence is purely speculative! We need to discuss this. -->


# Results: Prediction of Risk for Occult Disease {#sec-results-risk}

For a clinical application of the model we are interested in the risk of occult metastases rather than the observed patterns of lymph node involvement. We want to estimate the risk for occult disease in clinically negative LNLs, given the patient's individual diagnosis. In terms of our model, the diagnosis consists of the T-category, the lateralization of the tumor (if it extend over the mid-sagittal plane), and which LNLs are clinically involved based on imaging and possibly fine needle aspiration (FNA). For the results shown in this section, we assume that involvement of a LNL is clinically diagnosed through imaging with a sensitivity of 81% and a specificity of 76% [@de_bondt_detection_2007]. For FNA we assume a specificity of 98% and a sensitivity of 80%. This amounts to the assumption that lymph node involvement confirmed by FNA is almost certainly true involvement, i.e. there are almost no false positive diagnoses.

![Histograms over the predicted risk of occult involvement in contralateral LNL II (left), III (middle), and IV (right), shown for various combinations of T-category, tumor lateralization, and clinical LNL diagnoses. All LNLs not explicitly mentioned in the legend, including the LNL for which the risk of occult disease was computed, where assumed to be clinically negative (specificity 76%, sensitivity 81%).](figures/fig_model_risks.svg){#fig-model-risks}

<!-- @Fig-model-risks shows this predicted risk of occult disease in the contralateral LNLs II, III, and IV for interesting combinations of these three risk factors. This risk is computed *given* a CT diagnosis assessing the per-LNL clinical involvement for which we assumed a sensitivity of 81% and a specificity of 76%. For the involvement in the LNls III and IV contralaterally, we also cosidered how the risk would be affected if the upstream LNL was confirmed to be metastatic using fine needle aspiration (FNA) with a specificity of 98% and a sensitivity of 80% [@de_bondt_detection_2007]. In the figure legends, this is noted e.g. for the orange historgam over the risk of contralateral LNL IV involvement as `c:III FNA+`, meaning that the contralateral LNL III was pathologically confirmed to harbor metastases via FNA.-->

## Contralateral LNL II

@Fig-model-risks (left panel) shows the predicted risk of occult disease in contralateral LNL II. The most important variable impacting the prediction for contralateral level II involvement in our model is the tumor's lateralization. A patient with a clearly lateralized early T-category tumor and clinically detected metastases in ipsilateral LNL II is predicted to have a 1-2% <!-- TODO: make this dynamic --> risk for occult disease in contralateral LNL II (green histogram). For a cN0 patient with a clearly lateralized early T-category tumor but *with* mid-sagittal extension, the risk increases to {{< var risk.early_ext_iN0_cN0_II >}}% (orange histogram).

Also advanced T-category increases the risk of occult disease but plays a lesser role. Considering the scenario of an early T-category tumor that crosses the midline and an ipsilateral neck where the LNLs II and III are clinically involved, the risk for occult contralateral LNL II disease is around {{< var risk.early_ext_iII+III_cN0_II >}}% (red histogram). For the same scenario and an advanced T-category tumor, the risk increases to {{< var risk.late_ext_iII+III_cN0_II >}}% (purple histogram).

Lastly, the predicted risk of occult contralateral LNL II involvement also increases with the degree of ipsilateral involvement. When an early T-category patient with a tumor that extends over the mid-sagittal line presents with a clinically N0 ipsilateral neck instead of involvement in the levels II and III, the risk is {{< var risk.early_ext_iN0_cN0_II >}}% instead of {{< var risk.early_ext_iII+III_cN0_II >}}%.

Taken together, for lateralized tumors, the risk of occult contralateral involvement remains low even for patients with advanced T-category tumors and ipsilateral involvement of LNLs II and III (blue histogram), making midline extension the main risk factor. However, advanced T-category and severe ipsilateral involvement may still considerably increase the predicted risk for contralateral involvement. 


## Contralalteral LNL III

As shown in the center subplot of @fig-model-risks, the risk for occult disease in the contralateral LNL III may only cross a 5% threshold if the upstream level II is clinically involved. Even for advanced T-category tumors extending over the midline with extensive ipsilateral involvement (green histogram), the risk of occult metastases in contralateral LNL III is only 2% <!-- TODO: make this dynamic --> if the upstream LNL II is clinically negative. For an advanced T-category tumors extending over the midline with clinical involvement of both ispilateral and contralateral LNL II involvement, the predicted risk in contralateral LNL III increases to 4-5% <!-- TODO: make this dynamic --> (blue histogram). If the clinical diagnosis of the contralateral upstream level II is pathologically confirmed by FNA the risk increases to {{< var risk.late_ext_iII_cII_FNA_III >}}% (red histogram). This is because the possibility that the clinical involvement in contralateral LNL II is a false positive diagnoses is almost excluded. If contralateral LNL II is involved, the predicted risk in contralateral LNL III is {{< var risk.late_noext_iII_cII_FNA_III >}}% even for lateralized tumors (orange histogram).

## Contralateral LNL IV

Our model's prediction for the risk in contralateral LNL IV is below 1% <!-- TODO: make this dynamic --> if the upstream LNL III is clinically negative, that even in the most extreme case of an advanced T-category tumor extending over the mid-sagittal line with metastases in the ipsilateral LNLs II-IV and the contralateral level II (green histogram). If additionally contralateral LNL III is clinically involved, the risk increases to {{< var risk.late_ext_iII+III+IV_cII+III_IV >}}% (blue histogram). Only when the involvement of the upstream level III is pathologically confirmed using FNA, we predict a substantially higher risk of {{< var risk.late_ext_iII+III+IV_cII+III_FNA_IV >}}% (orange histogram). This is because the prior probability for contralateral LNL III and IV involvement is so low that, even given a clinically positive diagnosis in LNL III, it is likely that the involvement in LNL III is a false possitive diagnosis both LNLs III and IV are negative. This possibility, however, is virtually excluded when the involvement in contralateral level III is confirmed by FNA.


## Contralateral LNLs I, V, and VII

Even for advanced T-category patients whose tumor crosses the midline and who present with extensive ipsi- and contralateral clinical involvement, the risk for involvement in the LNLs I and VII never exceeds 3%. Contralateral LNL V also shows only a very low risk for occult disease. Only in the extreme case of severe contralateral involvement including LNL IV, confirmed by FNA, the predicted risk is {{< var risk.late_ext_iI+II+III+IV+V+VII_cII+III+IV_FNA_V >}}%.


# Discussion {#sec-discussion}

## Summary

In this work we present a formalism to model the ipsi- and contralateral lymph node involvement in oropharyngeal SCC patients. An ipsilateral model has been previously developed and published [@ludwig_hidden_2021;@ludwig_modelling_2023]. Based on this, we introduce an extension that leaves the ipsilateral model unchanged, but extends it to the contralateral side in an intuitive and comprehensible manner. The model parameters are learned from a dataset of {{< var data.num_patients >}} patients from four institutions in whom ipsilateral and contralateral involvement was reported per per patient and LNL. The model takes the clincally diagnosed involvement of the LNLs and the primary tumor's T-category and lateralization into account when predicting the personalized risk for occult disease in any LNL of interest. Owing to the relatively few parameters, the model is highly interpretable and every parameter can be intuitively explained, while still being able to accurately describe the data on both ipsilateral and contralateral nodal involvement observed in the dataset.

To the best of our knowledge, this is the most comprehensive and detailed model of lymphatic tumor progression in oropharyngeal SCC available. The underlying data as well as the code is publicly available. While there was work on regional tumor spread, these models were conceptually different, more limited in the LNLs for which they make predictions, and not trained with real patient data [@benson_markov_2006;@jung_development_2017].


## Implications for Contralateral Elective Nodal Treatment

The predictions of this model are being used to inform a clinical trial on volume deescalation at the University Hospital Zurich [clinicaltrials.gov, NCT06563362 (DeEscO)<!-- TODO: add -->]. When accepting a 5% risk of occult disease in any given LNL, the model suggests the following contralateral elective irradiation (assuming the respective LNL is clinically healthy):

- For patients with lateralized tumors and without clinical involvement of contralateral LNLs, unilateral radiotherapy is performed. No contralateral LNLs are electively irradiated, irrespective of T-category and ipsilateral involvement.
- For patients without clinical involvement of contralateral LNLs but with tumors extending over the midline, only LNL II is electively irradiated. 
- LNL III is irradiated when LNL II is involved, irrespective of lateralization, T-category, and ipsilateral involvement. When the upstream LNL II is clinically negative, LNL III is not irradiated, except for the unlikely situation that contralateral LNL IV is involved.
- Irradiate LNL IV only when the upstream level III is confirmed to be involved.
- LNL V is not electively irradiated in most patients. Only in the most extreme cases, i.e., for advanced T-category tumors with midline extension and confirmed involvement of contralateral LNLs II to IV, LNL V may be irradiated.
- LNLs I and VII are not irradiated unless clinically involved.

In essence, this is a summary of the results in @sec-results-risk. However, it should be considered in light of the limitations outlined in @sec-discussion-limitations below.


## Limitations and Future Work {#sec-discussion-limitations}

### T-Category Dependence

The model has only one parameter, $p_\text{adv.}$, to describe differences in the patterns of involvement between early and advanced T-category. Higher involvement for advanced T-category is described by evolving the state of involvement overr a larger number of time-steps, while the probability of spread per time step, here the $b_v$ parameters, remains constant. Overall, the model captures the differences between early and advanced T-category very well as seen in @Fig-model-prevalences-overall. However, for some situations the observed difference between early vs advanced T-category in the data is greater or smaller than what our model predicts. This has previously been discussed for the involvement of ipsilateral LNL I [@ludwig_modelling_2023]. In the context of contralateral spread, the prevalence of midline extension is overestimated for early T-category tumors and underestimated for advanced T-category tumors, which is further discussed in @sec-prevalence-midext.


### Sensitivity and Specificity

As discussed in @sec-methods-consensus (and in more detail in @sec-consensus), we assumed for model training that the consensus across all diagnostic modalities represents the true state $X_v$ of lymph node involvement. This is appropriate for pathologically confirmed involvement but is an approximation for clinically diagnosed involvement, as the latter is - by definition - incapable of detecting occult disease. In principle, the model can be trained while  differentiating between pathologically confirmed and clinically diagnosed involvement, using a lower sensitivity and specificity for clinical diagnosis. This was not done here for two reasons: 1) this simplification allowed us to compare the observed prevalence of involvement to the model's prediction, and thereby investigate the model's capability to describe data with few interpretable parameters; and 2) the literature values for sensitivity and specificity of the diagnostic modalities are inconsistent with some aspects of the observed data. Future work may aim at developing novel concepts to rigorously differentiating between pathologically confirmed and clinically diagnosed involvement. 

### Tumor Subsites

Within the cohort of patients with oropharyngeal tumors, subgroups can be identified whose tumors are located in different subsites, e.g. at the base of the tongue or on the tonsils. The lymphatic metastatic spread patterns of these subgroups may differ slightly. If so, the model could benefit from more fine-grained information about the precise tumor subsite for its training and prediction. We have conducted preliminary work to show that a mixture model may be a promising approach to capture the subsite specific spread patterns [cite ICCR paper, @zora231470]. The additionally represents an approach to extend the model towards tumor locations in the oral cavity, hypopharynx, and larynx.


# Acknowledgement {.appendix}

This work was supported by:

- the Clinical Research Priority Program "Artificial Intelligence in Oncological Imaging" of the University of Zurich
- the Swiss Cancer Research Foundation under grant number KFS 5645-08-2022


# Consensus on most likely involvement {#sec-consensus .appendix}

The consensus on the most likely involvement state of a LNL was formed as follows: Suppose the involvement status $X_v$ of LNL $v$ was assessed using different diagnostic modalities $\mathcal{O} = \{ \text{MRI}, \text{CT}, \text{pathology}, \ldots \}$, each characterized by their own pair of sensitivity and specificity values $s_N^{\mathcal{o}}$ and $s_P^{\mathcal{o}}$, with $\mathcal{o} \in \mathcal{O}$. These values are tabulated in @tbl-spec-sens. Then we have $|\mathcal{O}|$ observations $z_v^{\mathcal{o}} \in \left[ 0, 1 \right]$, where 0 stands for "healthy" and 1 for "involved". We can then compute the most likely true involvement $X_v$ using the likelihood function

$$
\begin{aligned}
\ell \left( X_v \mid \{ z_v^{\mathcal{o}} \}_{\mathcal{o} \in \mathcal{O}} \right) = \prod_{\mathcal{o} \in \mathcal{O}}
\left( 1 - X_v \right) \cdot &\left[ z_v^{\mathcal{o}} \cdot \left( 1 - s_P^{\mathcal{o}} \right) + \left( 1 - z_v^{\mathcal{o}} \right) \cdot s_P^{\mathcal{o}} \right] \\
+ X_v \cdot &\left[ z_v^{\mathcal{o}} \cdot s_N^{\mathcal{o}} + \left( 1 - z_v^{\mathcal{o}} \right) \cdot (1 - s_N^{\mathcal{o}}) \right]
\end{aligned}
$$

We now assume the true state $X_v$ to take on the value 1 if $\ell \left( X_v = 1 \mid \ldots \right) > \ell \left( X_v = 0 \mid \ldots \right)$ and 0 otherwise. For example, if we have $z_\text{II}^\text{CT} = 0$ and $z_\text{II}^\text{MRI} = 1$ we would compute the following likelihoods:

$$
\begin{aligned}
\ell \left( X_\text{II} = 1 \mid z_\text{II}^\text{CT} = 0, z_\text{II}^\text{MRI} = 1 \right) &= \left( 1 - s_N^\text{CT} \right) \cdot s_N^\text{MRI} = 15.39\% \\
\ell \left( X_\text{II} = 0 \mid z_\text{II}^\text{CT} = 0, z_\text{II}^\text{MRI} = 1 \right) &= s_P^\text{CT} \cdot \left(1 - s_N^\text{MRI}\right) = 14.44\%
\end{aligned}
$$

In this example, we would thus assume the true state to be involved ($X_\text{II} = 1$).

This method of computing a consensus also ensures that the pathology reports always override any conflicting clinical diagnosis, due to pathology's high sensitivity and specificity.

| Modality  | Specificity | Sensitivity |
| :-------- | ----------: | ----------: |
| CT        |         76% |         81% |
| PET       |         86% |         79% |
| MRI       |         63% |         81% |
| FNA       |         98% |         80% |
| pathology |        100% |        100% |

: Specificity and sensitivity values from the literature [@de_bondt_detection_2007;@kyzas_18f-fluorodeoxyglucose_2008]. {#tbl-spec-sens}



# Contralateral Prevalence of Involvement {.appendix}

```{python}
#| echo: false
#| label: tbl-data-strat
#| tbl-cap: Contralateral involvement depending on whether the primary tumor extends over the mid-sagittal line, the T-category, and whether the ipsilateral LNL III was involved or healthy.
lnl_cols = get_lnl_cols("contra", lnls=["I", "II", "III", "IV"])
num_ipsi_inv = raw[get_lnl_cols("ipsi")].sum(axis="columns")

contra_inv = raw[lnl_cols].copy()
contra_inv.columns = contra_inv.columns.droplevel([0,1])
contra_inv["t_stage"] = raw[COL.t_stage].apply(lambda x: "early" if x <= 2 else "advanced")
contra_inv["ipsi"] = num_ipsi_inv.map(lambda x: str(x) if x <= 1 else "≥ 2")
contra_inv["midext"] = raw[COL.midext]

grouped = contra_inv.groupby(by=["t_stage", "ipsi", "midext"], dropna=False)
num_involved = grouped.sum()
total = grouped.count()
percent_involved = num_involved / total
idx = total.index.rename(["T-cat.", "ipsi", "Mid. ext."])

total.index = idx
num_involved.index = idx
percent_involved.index = idx

involved = num_involved.join(
  100 * percent_involved,
  rsuffix=" (%)",
)
involved.columns = pd.MultiIndex.from_product(
  [["I", "II", "III", "IV"],
   ["n", "%"]],
  names=["LNL", ""]
)
involved["total", "n"] = total["I"]
(
  involved
  .reset_index()
  .sort_values(
    by=["T-cat.", "ipsi", "Mid. ext."],
    ascending=[False, True, True],
  )
  .style
  .format(precision=2)
  .apply(right_align, subset=involved.columns[0:])
  .apply(highlight_t_stage, subset=["T-cat."])
  .apply(highlight_bool, subset=["Mid. ext."])
  .apply(highlight, subset=["ipsi"], mapping={
    "0": COLORS["green"],
    "1": COLORS["orange"],
    "≥ 2": COLORS["red"],
  })
  .hide()
)
```


# Prevalence of Midline Extension {#sec-prevalence-midext .appendix}

<!-- I moved this here, because we think this is probably irrelevant or distracting w.r.t. the main findings of the paper. But I do think it is somewhat interesting. -->

![Comparing the predicted (histograms) and observed (lines depicting beta posteriors) prevalence of midline extension for early (blue) and late (orange) T-category. While the prevalence is predicted correctly when marginalizing over T-category, the model cannot capture the degree of separation observed in the data. Since the tumor's midline extension is virtually always part of the diagnosis and hence *given* when predicting a patient's risk, we do not consider this discrepancy a major issue.](figures/fig_model_prevalences_midext.svg){#fig-model-prevalences-midext width="50%"}

In @fig-model-prevalences-midext, we plot the prevalence of midline extension in the data versus our model's prediction. It is obvious the model cannot match the large spread between early and advanced T-category seen in the data. This is because to achieve that, it would need to increase the advanced T-category patient's prior distribution over diagnosis times and at the same time reduce the probability of the tumor to cross the midline during a time-step. But since the time-priors parameter is also coupled with the spread probabilities among the LNLs, the model does not have that freedom.

<!-- Should the paragraphs below be part of the discussion? -->

However, we do not consider this discrepancy a major limitation of the model: We will not realistically be interested in the probability of midline extension, as it is always possible to assess it with high certainty. That is also the reason why we initially modelled the midline extension *not* as a random variable, but as a global risk factor that would have been turned on or off from the onset of a patient's disease evolution. This, however, lead to overly high risks for contralateral involvement in advanced T-category patients with midline extension, because then the model assumes an increased spread to the contralateral side from the onset of the disease. Which is probably not true in a majority of those cases. Thus, treating it as a random variable that only becomes true during a patient's disease evolution resulted in a better description of the data.

Formally, the wrong prediction of midline extension prevalence makes little difference, since it is always given: Instead of $P\left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c}, \epsilon \mid \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c} \right)$, we typically compute $P\left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \mid \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c}, \epsilon \right)$, which does not suffer from the wrong probability of midline extension, as the distribution over hidden states is renormalized:

$$
P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c} \mid \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c}, \epsilon \right) = \frac{P \left( \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c} \mid \mathbf{X}^\text{i}, \mathbf{X}^\text{c}, \epsilon \right) P \left( \mathbf{X}^\text{i}, \mathbf{X}^\text{c}, \epsilon \right)}{P \left( \mathbf{Z}^\text{i}, \mathbf{Z}^\text{c}, \epsilon \right)}
$$

Note that a distribution over $\epsilon$ appears both in the enumerator and the denominator, which largely cancel each other, leaving only the midline extension's effect on the distribution over hidden states in the prediction.

Also, the discrepancy in midline extension prevalence between early and advanced T-category is particularly pronounced in oropharyngeal SCC patients. For example, in oral cavity SCC, the midline extension only increases from 15.4% (20 out of 130) to 33.3% (13 out of 39).
